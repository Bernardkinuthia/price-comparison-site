name: Update Prices
on:
  schedule:
    - cron: "0 */6 * * *"   # run every 6 hours (fixed syntax)
  workflow_dispatch:        # allow manual run

permissions:
  contents: write          # Allow the workflow to write to the repository

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0    # Fetch full history to avoid sync issues
          
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
          
      - name: Install dependencies
        run: pip install -r requirements.txt
        
      - name: Run price updater
        env:
          AMAZON_ACCESS_KEY: ${{ secrets.AMAZON_ACCESS_KEY }}
          AMAZON_SECRET_KEY: ${{ secrets.AMAZON_SECRET_KEY }}
          AMAZON_ASSOCIATE_TAG: ${{ secrets.AMAZON_ASSOCIATE_TAG }}
        run: python update_prices.py
        
      - name: Commit & Push changes
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          
          # Pull latest changes to avoid conflicts
          git pull origin main --rebase || true
          
          # Check if there are changes to commit
          if [ -n "$(git status --porcelain)" ]; then
            git add prices.json
            git commit -m "Update prices.json - $(date -u +"%Y-%m-%d %H:%M UTC")"
            
            # Push with retry logic
            for i in {1..3}; do
              if git push origin main; then
                echo "‚úÖ Successfully pushed changes"
                break
              else
                echo "‚ö†Ô∏è Push failed, attempt $i/3. Pulling and retrying..."
                git pull origin main --rebase
                sleep 2
              fi
            done
          else
            echo "üìù No changes to commit"
          fi
